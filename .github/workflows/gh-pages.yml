name: github pages

# Only run this when the master branch changes
on: push

# This job installs dependencies, build the book, and pushes it to `gh-pages`
jobs:
  build_docker_image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u $GITHUB_ACTOR --password-stdin
      - run: docker pull docker.pkg.github.com/$GITHUB_REPOSITORY/build-cache-no-buildkit || true
      - run: docker build devcontainer/ -t "prog1:latest" --cache-from=docker.pkg.github.com/$GITHUB_REPOSITORY/build-cache-no-buildkit
      - run: docker tag "prog1:latest" docker.pkg.github.com/$GITHUB_REPOSITORY/build-cache-no-buildkit && docker push docker.pkg.github.com/$GITHUB_REPOSITORY/build-cache-no-buildkit || true

  deploy-book:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    container: jO-Osko/prog1:latest
    steps:
    - uses: actions/checkout@v2

    # Build the book
    - name: Build the book
      run: |
        jupyter-book build zapiski

    # Push the book's HTML to github-pages
    - name: GitHub Pages action
      uses: peaceiris/actions-gh-pages@v3.6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./zapiski/_build/html
